generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Channel {
  WEB
  TELEGRAM
  VIBER
  MESSENGER
}

enum ModerationStatus {
  ACTIVE
  HIDDEN
}

enum RecommendationStatus {
  OK
  ERROR
  NO_RESULTS
}

enum PlaceSource {
  GOOGLE
  CURATED
}

model Place {
  placeId            String             @id
  externalPlaceId    String?            @unique
  name               String
  address            String?
  lat                Float
  lng                Float
  googleRating       Float?
  googleRatingsTotal Int?
  priceLevel         Int?
  types              Json?
  mapsUrl            String?
  source             PlaceSource        @default(GOOGLE)
  isFeatured         Boolean            @default(false)
  cuisineTags        String[]           @default([])
  lastFetchedAt      DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  feedback           PlaceFeedback[]
  aggregate          PlaceAggregate?

  @@index([lat, lng])
}

model RecommendationEvent {
  id                  String   @id @default(cuid())
  channel             Channel
  userIdHash          String
  userLat             Float?
  userLng             Float?
  requestId           String?
  queryText           String
  locationEnabled     Boolean?
  radiusMeters        Int?
  recommendedPlaceIds Json
  status              RecommendationStatus @default(OK)
  latencyMs           Int?
  errorMessage        String?
  resultCount         Int?     @default(0)
  parsedConstraints   Json?
  source              String?
  agentEnabled        Boolean?
  llmModel            String?
  toolCallCount       Int?
  fallbackUsed        Boolean?
  rawResponseJson     String?  @db.Text
  createdAt           DateTime @default(now())

  @@index([userIdHash, createdAt])
}

model PlaceFeedback {
  id                String            @id @default(cuid())
  placeId           String
  channel           Channel
  userIdHash        String
  rating            Int
  commentText       String?
  tags              Json?
  moderationStatus  ModerationStatus  @default(ACTIVE)
  createdAt         DateTime          @default(now())
  place             Place             @relation(fields: [placeId], references: [placeId], onDelete: Cascade)

  @@index([placeId, createdAt])
}

model PlaceAggregate {
  placeId               String   @id
  communityRatingAvg    Float    @default(0)
  communityRatingCount  Int      @default(0)
  foodbuddyRatingAvg    Float    @default(0)
  foodbuddyRatingCount  Int      @default(0)
  feedbackSummary       String?
  tagCounts             Json     @default("{}")
  lastUpdatedAt         DateTime?
  place                 Place    @relation(fields: [placeId], references: [placeId], onDelete: Cascade)
}

model ChatState {
  telegramChatIdHash String   @id
  lastLat            Float
  lastLng            Float
  updatedAt          DateTime @updatedAt
}

model RagDocument {
  placeId   String   @id
  content   String
  embedding Unsupported("vector")
  updatedAt DateTime @updatedAt
}

model LLMSettings {
  id              String   @id @default("default")
  llmEnabled      Boolean  @default(false)
  llmProvider     String   @default("openai")
  llmModel        String   @default("gpt-5-mini")
  llmSystemPrompt String   @db.Text
  reasoningEffort String   @default("medium")
  verbosity       String   @default("medium")
  updatedAt       DateTime @updatedAt
}

model SearchSession {
  id            String   @id @default(cuid())
  sessionId     String   @unique
  channel       String?
  pendingAction String?
  pendingKeyword String?
  lastLat       Float?
  lastLng       Float?
  lastRadiusM   Int?
  lastQuery     String?
  nextPageToken String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
